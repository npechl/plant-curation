# Pipeline Guidelines

## Introduction
This pipeline processes retrieved sequence data, curates it into marker-specific FASTA files with taxonomy, optionally concatenates ITS subregions, and performs alignment and taxonomic validation.

## Requirements

```bash
conda env create -f environment.yml
```

### Sativa Installation

These steps assume you’re using **Linux or macOS** (Windows isn’t officially supported).

#### Prerequisites

- You need **Python 3** installed (Python 2 won’t work).  
- You need a C compiler (e.g. GCC or clang) — recent versions are recommended.  
- You should have `git` installed so you can clone the repository.

#### Installation steps

1. **Clone the repository**  
   ```bash
   git clone https://github.com/amkozlov/sativa.git
   cd sativa
   ```
2. Run the install script
    ```bash
    ./install.sh
    ```
For more detailed instructions, visit [`sativa's GitHub repo`](https://github.com/amkozlov/sativa).

## Input
A tab-delimited file (named `download` in the example) with the following fields:
- `nuc`: nucleotide sequence (can include `-` gaps)
- `marker_code`: marker label (in our case: `ITS`, `ITS1`, `ITS2`, `trnL`)
- `kingdom`, `phylum`, `class`, `order`, `family`, `genus`, `species`
- `processid`: unique identifier

Please refer to [`01.data_retrieval.md`](01.data_retrieval.md).

## Pipeline Overview

### Step #1. Data Curation within `R` 
Run the provided R script (`tsv2fasta.R`) to use the raw download file, remove missing/invalid entries, and generate curated FASTA + taxonomy files for ITS and trnL markers.

```bash
Rscript tsv2fasta.R
```

> **Output files:**
> - `ITS0.fasta.gz`  
> - `trnL.fasta.gz`  
> - `ITS0.tax`  
> - `trnL.tax`  

### Step #2. Running `ITSx`

Run **ITSx** on the input FASTA file to extract and save all ITS subregions using desired number of CPU cores:

```bash
ITSx -i ITS0.fasta.gz -o {names of outputs} --cpu {number of threads} --save_regions all
```

> **Output files:**
> - `{names of outputs}.ITS1.fasta`  
> - `{names of outputs}.ITS2.fasta`
> - `{names of outputs}.5_8S.fasta`   

### Step #3. ITS Concatenation
Run the provided R script (`construct_ITS_region.R`) to concatenate `ITS1`, `5.8S`, and `ITS2` into a single sequence per sample.

```bash
Rscript construct_ITS_region.R
```

> **Output file:**
> - `ITS.fasta` (concatenated ITS sequences)

### Step #3b. Produce .tax files

The newly constructed FASTA files that have been verified with ITSx now require a corresponding .tax file that matches them perfectly. This file can be generated using the provided R script, which extracts the necessary information directly from the FASTA headers and writes it into the required format.

```bash
Rscript tax_from_fasta.R
```

### Step #4. Alignment with `MAFFT`

Align the curated FASTA:

```bash
mafft --auto {db}.ITS.fasta > ITS_aligned.fasta
mafft --auto {names of outputs}.ITS1.fasta > ITS1_aligned.fasta
mafft --auto {names of output}.ITS2.fasta > ITS2_aligned.fasta
mafft --auto trnL.fasta > trnL_aligned.fasta
```

> **Output files:**
> - `ITS_aligned.fasta`
> - `ITS1_aligned.fasta`
> - `ITS2_aligned.fasta`
> - `trnL_aligned.fasta`

### Step #5. Taxonomic Validation with `SATIVA`

Run [SATIVA](https://github.com/amkozlov/sativa) on the aligned FASTA + taxonomy table:

```bash
python sativa.py -s full.ITS_aligned.fasta -t ITS.tax -T 2 -x bot -n output
python sativa.py -s trnL_aligned.fasta -t trnL.tax -T 2 -x bot -n output
```

> **Output files:**
> - `output.final_epa.jplace`
> - `output.l1out_seq.jplace`
> - `output`
> - `output.mis`
> - `output.refjson`

### Step #6. Filter based on Sativa results

Run the provided R script (`apply_sativa.R`) to correct misclassifications, using sativa .mis output and original .tax file to update it.

```bash
Rscript apply_sativa.R
```

## Outputs
Final outputs include:
- Curated FASTA + taxonomy tables (`*.fasta.gz`, `*.tax`)
Specifically: 
**Output files:**
- `ITS.fasta`
- `ITS1.fasta`
- `ITS2.fasta`
- `trnL.fasta`
- `ITS.tax`
- `ITS1.tax`
- `ITS2.tax`
- `trnL.tax`


## Notes & Tips
- File names are flexible; update script paths accordingly.  
- Ensure MAFFT and SATIVA are available in `$PATH`.  
- Large datasets may require additional memory/CPU.  
- SATIVA `-T` option controls number of threads.  
